<?xml version="1.0"?>
<project name="install-kotlin-wrapper" default="install">
<!--
required props:
 ${wrapper.jar}
 ${wrappers.path}
 ${npm.path}
-->
    <target name="install" depends="install-if-not-installed, message-if-already-installed"/>


    <target name="install-if-not-installed" depends="set-props" unless="installed">
            <echo message="extract name=${wrapper.name}, ver=${wrapper.ver}"/>

            <unzip src="${wrapper.jar}" dest="${wrapper.dest-path}">
                <patternset>
                    <include name="*.js"/>
                    <include name="*.js.map"/>
                    <exclude name="*.meta.js"/>
                </patternset>
            </unzip>
            <echo file="${wrapper.dest-path}/package.json" append="false"><![CDATA[
{
  "main": "${wrapper.name}.js",
  "devDependencies": {},
  "dependencies": {},
  "peerDependencies": {},
  "optionalDependencies": {},
  "bundledDependencies": [],
  "name": "${wrapper.name}",
  "version": "${wrapper.ver}"
}
]]>
            </echo>
            <echo file="${wrapper.dest-path}/install.cmd" append="false"><![CDATA[
@ECHO OFF
REM file to avoid wrong output encoding in console. <exec> does not allow to execute more than one command
CHCP 65001 >nul
${npm.path}\npm install ${wrapper.dest-path}
]]>
            </echo>

            <exec executable="cmd">
                <arg value="/c"/>
                <arg value="${wrapper.dest-path}/install.cmd"/>
            </exec>
    </target>


    <target name="message-if-already-installed" depends="set-props" if="installed">
        <echo message="already installed: name=${wrapper.name}, ver=${wrapper.ver}"/>
    </target>


    <target name="set-props">
        <!--<local name="wrapper.ver-path"/>-->
        <!--<local name="wrapper.name-path"/>-->
        <!--<local name="wrapper.ver"/>-->
        <!--<local name="wrapper.name"/>-->
        <!--<local name="wrapper.dest-path"/>-->

        <dirname property="wrapper.ver-path" file="${wrapper.jar}"/>
        <dirname property="wrapper.name-path" file="${wrapper.ver-path}"/>

        <basename property="wrapper.ver" file="${wrapper.ver-path}"/>
        <basename property="wrapper.name" file="${wrapper.name-path}"/>

        <property name="wrapper.dest-path" value="${wrappers.path}/${wrapper.name}"/>

        <available file="${wrapper.dest-path}/install.cmd" property="installed"/>
    </target>
</project>